/*
 tagorila 2016-06-10 
*/
"use strict";var app=angular.module("app",["ngAnimate","ngDialog","ngRoute","angular-preload-image","ngMaterial","angular-whenScrolled","masonry"]).config(["$locationProvider","$routeProvider","$sceDelegateProvider","$httpProvider",function(a,b,c,d){a.html5Mode(!0),b.when("/search/:searchText/:order",{templateUrl:"views/search.html",controller:"SearchCtrl"}),b.when("/search/:searchText/:order/:dateAfter",{templateUrl:"views/search.html",controller:"SearchCtrl"}),b.when("/media/:itemId",{templateUrl:"views/user.html",controller:"SearchCtrl"}),b.when("/search/",{templateUrl:"views/search.html",controller:"SearchCtrl"}),b.when("/user/",{templateUrl:"views/user.html",controller:"SearchCtrl"}),b.when("/user/:username",{templateUrl:"views/user.html",controller:"SearchCtrl"}),b.when("/tos/",{templateUrl:"views/tos.html"}),b.otherwise({redirectTo:"/search/"}),c.resourceUrlWhitelist(["self","https://scontent.cdninstagram.com/**"]),delete d.defaults.headers.common["X-Requested-With"]}]).run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]);app.service("anchorSmoothScroll",function(){this.scrollTo=function(a){function b(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function c(a){for(var b=document.getElementById(a),c=b.offsetTop,d=b;d.offsetParent&&d.offsetParent!=document.body;)d=d.offsetParent,c+=d.offsetTop;return c}var d=b(),e=c(a),f=e>d?e-d:d-e;if(100>f)return void scrollTo(0,e);var g=Math.round(f/100);g>=20&&(g=20);var h=Math.round(f/25),i=e>d?d+h:d-h,j=0;if(e>d)for(var k=d;e>k;k+=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i+=h,i>e&&(i=e),j++;else for(var k=d;k>e;k-=h)setTimeout("window.scrollTo(0, "+i+")",j*g),i-=h,e>i&&(i=e),j++}}),app.service("VideosService",["$window","$rootScope","$log",function(a,b,c){function d(a){c.info("YouTube Player is ready"),g.player.loadVideoById(g.videoId)}function e(a){a.data==YT.PlayerState.PLAYING?(g.state="playing",console.log(g.state),g.playClass=!0):a.data==YT.PlayerState.PAUSED?(g.state="paused",g.playClass=!1,console.log(g.state)):a.data==YT.PlayerState.ENDED?(g.state="ended",g.playClass=!1,console.log(g.state)):a.data==YT.PlayerState.CUED&&(g.state="cued",g.playClass=!1,console.log(g.state)),b.$apply()}var f=this,g={ready:!1,player:null,playerId:null,videoId:null,videoTitle:null,playerHeight:"100%",playerWidth:"100%",state:"stopped",playClass:!1};a.onYouTubeIframeAPIReady=function(){c.info("Youtube API is ready"),g.ready=!0,b.$apply()},this.bindPlayer=function(a){g.ready?(c.info("Binding to "+a),g.playerId=a):c.error("ughh the youtube Iframe API isn't ready")},this.createPlayer=function(){return c.info("Creating a new Youtube player for DOM id "+g.playerId+" and video "+g.videoId),new YT.Player(g.playerId,{height:g.playerHeight,width:g.playerWidth,playerVars:{rel:0,showinfo:0},events:{onReady:d,onStateChange:e}})},this.loadPlayer=function(){g.ready&&g.playerId&&(g.player&&g.player.destroy(),g.player=f.createPlayer())},this.stop=function(){g.player.stopVideo()},this.play=function(){"paused"==g.state?g.player.playVideo():"playing"==g.state?g.player.pauseVideo():"cued"==g.state&&g.player.playVideo()},this.pause=function(){g.player.pauseVideo()},this.expandVid=function(a){},this.launchPlayer=function(a,b){return g.videoId=a,g.videoTitle=b,console.log(g),f.bindPlayer("player-"+a),f.loadPlayer(),g},this.launchRelated=function(a,b){return g.videoId=a,g.videoTitle=b,f.bindPlayer("player-"+a),f.loadPlayer(),g},this.getYoutube=function(){return g}}]),app.factory("Instagram",["$http",function(a){var b="https://www.googleapis.com/youtube/v3/search",c="AIzaSyDyac0NDqikzIe07Nu0Y19MINwrxsDDPNw";return{get:function(d,e,f,g,h){var i={params:{order:f,pageToken:h,type:"video",key:c,maxResults:d,q:e,publishedAfter:g,part:"snippet",callback:"JSON_CALLBACK"}};return console.log(i),a.jsonp(b,i)}}}]),app.factory("youtubeRelated",["$http",function(a){var b="https://www.googleapis.com/youtube/v3/search",c="AIzaSyDyac0NDqikzIe07Nu0Y19MINwrxsDDPNw";return{get:function(d,e,f){var g={params:{pageToken:f,type:"video",key:c,maxResults:d,relatedToVideoId:e,part:"snippet",callback:"JSON_CALLBACK"}};return console.log(g),a.jsonp(b,g)}}}]),app.factory("Instagram2",["$http",function(a){return{get:function(b,c){var d=c,e={params:{count:b,callback:"JSON_CALLBACK"}};return a.jsonp(d,e)}}}]),app.factory("Instagram3",["$http",function(a){return{get:function(b,c){var d="https://api.instagram.com/v1",e="1ca7d98f346549fc95641d0b04307f82",f="/users/"+c+"/media/recent",g=d+f,h={params:{client_id:e,count:b,callback:"JSON_CALLBACK"}};return a.jsonp(g,h)}}}]),app.factory("instaLink",["$http",function(a){return{get:function(b){var c="https://api.instagram.com/oembed?url=http://instagram.com/p/",d="1ca7d98f346549fc95641d0b04307f82",e=b,f=c+e,g={params:{client_id:d,callback:"JSON_CALLBACK"}};return a.jsonp(f,g)}}}]),app.factory("instaMedia",["$http",function(a){return{get:function(b){var c="https://api.instagram.com/v1",d="1ca7d98f346549fc95641d0b04307f82",e="/media/"+b,f=c+e,g={params:{client_id:d,callback:"JSON_CALLBACK"}};return a.jsonp(f,g)}}}]),app.controller("SearchCtrl",["$scope","$rootScope","$route","$routeParams","$location","$anchorScroll","Instagram","Instagram2","Instagram3","instaMedia","instaLink","ngDialog","anchorSmoothScroll","$window","$mdDialog","VideosService","youtubeRelated","$mdMedia","$mdBottomSheet",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){b.what=[],b.video=[],b.video.id=[],b.modal=[],b.modal.yo=[],a.location=e,a.related=[],a.youtube=p.getYoutube(),b.tagLink=function(a){window.open("/search/"+a,"_self")},b.swipe=function(){l.close()},String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();("number"!=typeof b||!isFinite(b)||Math.floor(b)!==b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return-1!==d&&d===b}),b.modalOpen=function(b){a.what.iUrl=b;var c=a.what.iUrl.split("/");a.what.instaUrl=c[4],e.path("/media/"+a.what.instaUrl,!1)},b.openPlain=function(b,d){console.log(b),a.what.lin=b.id.videoId,a.what.cap=b.snippet.description,a.what.usern=b.snippet.channelName,a.what.daty=b.publishedAt,a.what.uId=b.snippet.channelId,a.what.mediaId=d,a.video.id=b.id;var f=l.open({template:"modalTemplate.html",className:"ngdialog-theme-plain",scope:a});f.closePromise.then(function(a){"search"===c.current.scope.view&&e.path("/"+c.current.scope.view+"/"+c.current.params.searchText,!1),"user"===c.current.scope.view&&e.path("/"+c.current.scope.view+"/"+c.current.params.username,!1)})},a.search=[],a.search.results=24,a.search.date=[],a.dateParse=function(a){var b=new Date((new Date).setDate((new Date).getDate()-a)),c=b.toISOString();return c},a.customFullscreen=r("xs")||r("sm"),a.launchPanel=function(a){},a.clearRelated=function(){a.related.items=[]},a.youtubeRelated=function(b){a.related.noMore=!1,a.related.itemsDisplayedInList=6,console.log(a.youtube),s.show({template:'     <md-bottom-sheet class="pos-f-b" layout="column" ng-cloak><div layout-wrap  layout-align="center" style="max-width:1920px;" layout="row" show="related.items"> <div flex id="item-{{item.id.videoId}}" style="position: relative;" class="animate instapic related" ng-repeat="item in filteredItems2 = (related.items.slice().reverse())"><a class="tile" ng-click="launch($event, item.id.videoId, item.snippet.title);"> <img  preload-image ng-src="{{ item.snippet.thumbnails.high.url }}" default-image="img/loading-bubbles.svg" fallback-image="{{ item.snippet.thumbnails.default.url }}"  title="" alt=""></a><div class="title-overlay"><h4 style="margin:0;">{{item.snippet.title}}</h4><small>{{item.snippet.date | date:"shortTime"}}</small></div></div><div ng-show="error" class="error"></div><md-button ng-show="related.items" ng-hide="related.noMore" class="md-mini" aria-label="next related" ng-click="youtubeRelated(more);"> <md-icon class="glyphicon glyphicon-forward"></md-icon></md-button><h3 ng-show="related.noMore">No more results</h3> </div></md-bottom-sheet>',hasBackdrop:!1,disableParentScroll:!1,clickOutsideToClose:!1,preserveScope:!0,scope:a}),q.get(6,a.youtube.videoId,a.related.pagination).success(function(b){return b.error?void(a.related.error=b.error.code+" | "+b.error.message):void(b.items.length>0?(a.related.pagination=b.nextPageToken,a.related.prev=b.nextPageToken,a.related.items=b.items,a.related.loading=!1,a.related.itemsDisplayedInList<=a.related.items.length&&(a.related.itemsDisplayedInList=a.related.itemsDisplayedInList+6,a.loading=!1),b.items.length<1&&(a.related.error="no more results")):a.related.error="no results")}).error(function(b){a.related.noMore=!0})},a.$watch("$routeChangeStart",function(){var c=document.createElement("script");c.src="https://www.youtube.com/iframe_api";var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(c,d);var f=e.path().split("/");switch(a.search.term=f[2],a.view=f[1],null==f[3]?a.search.order="relevance":a.search.order=f[3],null==f[4]?a.search.dateAfter="any":a.search.dateAfter=f[4],b.items=null,b.pagination=null,a.search.dateAfter){case"any":a.search.dateAfterISO="1970-05-31T03:51:07.968Z";break;case"day":a.search.dateAfterISO=a.dateParse(1);break;case"week":a.search.dateAfterISO=a.dateParse(7);break;case"month":a.search.dateAfterISO=a.dateParse(30);break;case"threemonths":a.search.dateAfterISO=a.dateParse(90);break;case"year":a.search.dateAfterISO=a.dateParse(365)}"search"===a.view&&a.search.term.length>1&&g.get(a.search.results,a.search.term,a.search.order,a.search.dateAfterISO).success(function(c){t(b,c),document.title="#"+a.search.term+" | TAGORI.LA"}),"search"===a.view&&a.search.term.length<1&&(a.items=null,a.error=null,document.title="TAGORI.LA | Instagram viewer"),"user"===a.view&&a.search.term.length>1&&i.get(a.search.results,a.search.term).success(function(c){t(b,c),a.gotoElement("hashtext"),document.title=a.items[0].user.username+"'s feed' | TAGORI.LA"}),"user"===a.view&&a.search.term.length<1?(a.items=null,a.error=null,document.title="TAGORI.LA | Instagram viewer"):document.title="TAGORI.LA | Instagram viewer"}),b.$on("$routeChangeStart",function(a,c,d){return"yarr"!==b.modal.yo?!0:void l.close()}),b.$on("ngDialog.opened",function(a,c){b.modal.yo="yarr"}),b.$on("ngDialog.closing",function(a,c){b.modal.yo=[]}),a.gotoVid=function(){m.scrollTo(a.youtube.playerId)},a.loading=!1,a.itemsDisplayedInList=24,a.loadMore=function(){a.loading||(a.noMore=!1,a.loading=!0,g.get(a.search.results,a.search.term,a.search.order,a.search.dateAfterISO,a.pagination).success(function(b){return b.error?void(a.error=b.error.code+" | "+b.error.message):void(b.items.length>0?(a.pagination=b.nextPageToken,a.items=b.items.concat(a.items),a.loading=!1,a.itemsDisplayedInList<=a.items.length&&(a.itemsDisplayedInList=a.itemsDisplayedInList+24,a.loading=!1),b.items.length<1&&(a.error="no more results")):a.error="no results")}).error(function(b){a.noMore=!0}))},a.launch=function(b,c,d){var e=(r("sm")||r("xs"))&&a.customFullscreen;o.show({locals:{},template:'<md-dialog-content><div layout="row" class="iframe-container"><div id="player-'+c+'" style="z-index: 999;"></div></div></md-dialog-content>  <md-dialog-actions>    <md-button ng-click="closeDialog()" class="md-primary">     <md-icon class="glyphicon glyphicon-remove"></md-icon>    </md-button>  </md-dialog-actions>',targetEvent:b,parent:angular.element(document.body),hasBackdrop:!1,disableParentScroll:!1,clickOutsideToClose:!0,fullscreen:e,scope:a,preserveScope:!0,onComplete:function(){p.launchPlayer(c,d)}}),a.$watch(function(){return r("xs")||r("sm")},function(b){a.customFullscreen=b===!0})},a.closeDialog=function(){o.hide()},a.launchRelated=function(a,b){p.launchRelated(a,b)},a.stopVideo=function(){p.stop()},a.playVideo=function(){p.play()},a.pauseVideo=function(){p.pause()},a.gotoElement=function(a){m.scrollTo(a)};var t=function(b,c){return console.log(c),c.error?(b.error,a.$watch("scope.error",function(a){o.show(o.alert().title("Error").content(c.error.code+" | "+c.error.message).ariaLabel("Error").ok("Ok").targetEvent(a))}),void(b.error="")):void(c.items.length>0?(b.error="",b.items=c.items,c.nextPageToken&&(b.error="",b.items=c.items,b.pagination=c.nextPageToken)):(b.error,a.$watch("scope.error",function(a){o.show(o.alert().title("Error").content("This query has returned no results").ariaLabel("Error").ok("Ok").targetEvent(a))})))}}]);